<div style="display: grid; grid-template-columns: 9fr 2fr">
  <div *ngIf="false" style="border-right: var(--border-table);  height: 100dvh; overflow: auto; background: var(--color-background-component);">
    <div *ngIf="simpleFML as fml" style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem">
      <m-table mSize="small">
        <tr *ngFor="let o of fml.objects | values">
          <td>
            <div>{{o.name}} ({{o.fields.length}})</div>
            <div class="description" *ngIf="o.resource !== o.name">{{o.resource}}</div>
          </td>
        </tr>
      </m-table>

      <m-table mSize="small">
        <tr *ngFor="let r of fml.rules">
          <td>
            <div>{{r.name}}</div>
            <div class="description">
              {{r.action}}
            </div>
            <div class="description">
              {{r.sourceObject}}:{{r.sourceField}} -> {{r.targetObject}}:{{r.targetField}}
            </div>
          </td>
        </tr>
      </m-table>
    </div>
  </div>

  <div id="drawflow" style="height: 100vh" (dragover)="onDragOver($event)" (drop)="onDrop($event)"></div>

  <div style="border-left: var(--border-table);  height: 100dvh; overflow: auto; background: var(--color-background-component)">
    <div style="border-bottom: var(--border-table); padding: 1rem" class="m-justify-center">
      <m-radio-group [(ngModel)]="isExpanded" (ngModelChange)="setExpand($event)">
        <label m-radio-button [mValue]="true">Expanded</label>
        <label m-radio-button [mValue]="false">Collapsed</label>
      </m-radio-group>
    </div>

    <div
      *ngIf="!nodeSelected"
      style="padding: 1rem; border-bottom: var(--border-table)"
    >
      <h5>Transformers</h5>
      <m-list mSeparated>
        <m-list-item
          *ngFor="let rd of ruleDescriptions"
          class="m-clickable"
          draggable="true"
          (dragstart)="onDragStart($event, rd)"
        >
          <div>{{rd.name}}</div>
          <div class="description">{{rd.description}}</div>
        </m-list-item>
      </m-list>
    </div>


    <div
      *ngIf="nodeSelected as node"
      style="padding: 1rem; border-bottom: var(--border-table);"
    >
      <!--      <app-structure-definition-tree-->
      <!--        *ngIf="node.data.obj"-->
      <!--        [fhir]="node.data.obj?._fhir | json | apply: encodeURIComponent"-->
      <!--        (selected)="onStructureItemSelect($event)"-->
      <!--      ></app-structure-definition-tree>-->

      <div *ngIf="node.data.obj as obj">
        <h5>Resource</h5>

        <m-table mSize="small">
          <tr *ngFor="let f of obj.fields">
            <td>
              <ng-container *ngIf="f | apply: isComplexResource; else name">
                <a *ngIf="f | apply: isResourceSelectable; else name" (mClick)="onStructureItemSelect(obj, f.name)">{{f.name}}</a>
                <div class="description">{{f.types | join: ', '}}</div>
              </ng-container>
              <ng-template #name>{{f.name}}</ng-template>
            </td>
          </tr>
        </m-table>
      </div>

      <div *ngIf="node.data.rule as rule">
        <m-form-item mLabel="Rule">
          <m-input [(ngModel)]="rule.name"></m-input>
        </m-form-item>


        <div class="form-view"
          style="border-top: var(--border-table); margin-inline: -1rem; padding: 1rem 1rem 0;"
          *ngIf="rule.sourceObject || rule.targetObject"
        >
          <m-form-item mLabel="Source" *ngIf="rule.sourceObject">
            {{rule.sourceObject}}:<b>{{rule.sourceField}}</b>
          </m-form-item>
          <m-form-item mLabel="Target" *ngIf="rule.targetObject">
            {{rule.targetObject}}:<b>{{rule.targetField}}</b>
          </m-form-item>
        </div>


        <!--        <pre>{{rule | json}}</pre>-->
      </div>
    </div>
  </div>

</div>
