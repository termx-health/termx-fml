<div style="height: 2.5rem; display: flex; align-items: center; padding-inline: 1rem; border-bottom: 1px solid var(--color-borders);">
  <div style="width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr" class="m-justify-between">
    <div class="m-items-middle">
      <m-button (mClick)="export()" mSize="small">Export</m-button>
      <m-dropdown [mHideIfEmpty]="false">
        <div *m-dropdown-container>{{localstorage.getItem('selected_structure_map')}}.json</div>
        <ng-container *ngFor="let m of maps">
          <a *m-dropdown-item (mClick)="localstorage.setItem('selected_structure_map', m); init()">{{m}}</a>
        </ng-container>
      </m-dropdown>
    </div>

    <div class="m-items-middle" style="justify-self: center">
      <!--      <m-radio-group [(ngModel)]="isExpanded" (ngModelChange)="setExpand($event)" mSize="small">-->
      <!--        <label m-radio-button [mValue]="true">Expanded</label>-->
      <!--        <label m-radio-button [mValue]="false">Collapsed</label>-->
      <!--      </m-radio-group>-->
      <!--    <m-button (mClick)="isAnimated = !isAnimated" mSize="small">Animation {{isAnimated ? 'OFF' : 'ON'}}</m-button>-->
    </div>

    <div style="justify-self: end">
      Animation
      <nz-switch [(ngModel)]="isAnimated" nzSize="small"></nz-switch>
    </div>

  </div>
</div>

<div style="height: calc(100dvh - 2.5rem); display: grid; grid-template-columns: 2fr 8fr 2fr">
  <div *ngIf="true" style="border-right: var(--border-table);  height: 100%; overflow: auto; background: var(--color-background-component);">
    <div *ngIf="simpleFML as fml " style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem">
      <m-table mSize="small">
        <tr *ngFor="let o of fml.objects | values ">
          <td>
            <div class="m-justify-between">
              <div>{{o.name}} ({{o.fields.length}})</div>
              <span class="m-subtitle">x: {{o.position?.x ?? '-'}}; y:{{o.position?.y ?? '-'}}</span>
            </div>
            <div class="description">{{o.resource}}</div>
          </td>
        </tr>
      </m-table>

      <m-table mSize="small">
        <tr *ngFor="let r of fml.rules">
          <td>
            <div class="m-justify-between">
              <div>{{r.name}}</div>
              <span class="m-subtitle">{{r.action}}</span>
            </div>
            <div class="description">
              <div>source: {{r.sources | join: ', '}}</div>
              <div>target: {{r.targets | join: ', '}}</div>
            </div>
          </td>
        </tr>
      </m-table>

      <m-table [mData]="fml.connections" mSize="small">
        <tr *mTableHead>
          <th>Source</th>
          <th>Idx</th>
          <th>Target</th>
          <th>Idx</th>
        </tr>
        <tr *ngFor="let con of fml.connections">
          <td>{{con.sourceObject}}</td>
          <td>{{con.sourceFieldIdx}}</td>
          <td>{{con.targetObject}}</td>
          <td>{{con.targetFieldIdx}}</td>
        </tr>
      </m-table>
    </div>
  </div>

  <div [class.drawflow--animated]="isAnimated">
    <div id="drawflow" style="height: 100%; width: 100%; outline: none" (dragover)="onDragOver($event)" (drop)="onDrop($event)"></div>
  </div>

  <div style="border-left: var(--border-table);  height: 100%; overflow: auto; background: var(--color-background-component)">
    <div
      *ngIf="!nodeSelected"
      style="padding: 1rem; border-bottom: var(--border-table);"
    >
      <h5>Transformers</h5>
      <m-list mSeparated>
        <m-list-item
          *ngFor="let rd of ruleDescriptions"
          class="m-clickable"
          draggable="true"
          (dragstart)="onDragStart($event, rd)"
        >
          <div>{{rd.name}}</div>
          <div class="description">{{rd.description}}</div>
        </m-list-item>
      </m-list>
    </div>


    <div
      *ngIf="nodeSelected as node"
    >
      <!-- Resource -->
      <div *ngIf="node.data.obj as obj">
        <div style="padding: 1rem; border-bottom: var(--border-table);">
          <h5>Resource | {{obj.mode}}</h5>
        </div>

        <m-table mSize="small" style="padding: 1rem; border-bottom: var(--border-table); display: block">
          <tr *ngFor="let f of obj.fields">
            <td>
              <div class="m-items-top m-justify-between">
                <div>
                  <a *ngIf="f | apply: isResourceSelectable; else name" (mClick)="onStructureItemSelect(obj, f.name)">{{f.name}}</a>
                  <div class="description">{{f.types | join: ', '}}</div>
                </div>
                <ng-template #name>{{f.name}}</ng-template>

                <span class="m-subtitle">{{f.required ? '1' : '0'}}{{f.multiple ? '..*' : '..1'}}</span>
              </div>
            </td>
          </tr>
        </m-table>


        <div class="form-view" style="padding: 1rem; border-bottom: var(--border-table);">
          <m-form-item mLabel="Source" *ngIf="obj.name | apply: fml.getSources as srcs">
            <span *ngIf="!srcs?.length">-</span>
            <div *ngFor="let src of srcs">{{src.object}}<b *ngIf="src.field">:{{src.field}}</b></div>
          </m-form-item>
          <m-form-item mLabel="Target" *ngIf="obj.name | apply: fml.getTargets as tgts">
            <span *ngIf="!tgts?.length">-</span>
            <div *ngFor="let tgt of tgts">{{tgt.object}}<b *ngIf="tgt.field">:{{tgt.field}}</b></div>
          </m-form-item>
        </div>
      </div>

      <!-- Rule -->
      <div *ngIf="node.data.rule as rule">
        <div style="padding: 1rem; border-bottom: var(--border-table);">
          <h5>Rule</h5>
          {{rule.name}}
        </div>

        <div class="form-view" style="padding: 1rem; border-bottom: var(--border-table);">
          <m-form-item mLabel="Action">
            {{rule.action}}
          </m-form-item>

          <m-form-item [mLabel]="clbl">
            <ng-template #clbl>
              Condition
              <m-icon-button mIcon="edit" (mClick)="editStart(conditionModal)"/>
            </ng-template>

            {{rule.condition ?? '-'}}
          </m-form-item>

          <m-form-item [mLabel]="plbl">
            <ng-template #plbl>
              Parameters
              <m-icon-button mIcon="edit" (mClick)="editStart(parameterModal)"/>
            </ng-template>

            <span *ngIf="!rule.parameters?.length">-</span>
            <ul>
              <li *ngFor="let p of rule.parameters">
                <kbd *ngIf="p.type === 'var'; else lbl" class="description">{{p.value}}</kbd>
                <ng-template #lbl><code>{{p.value}}</code></ng-template>
              </li>
            </ul>
          </m-form-item>
        </div>

        <div class="form-view" style="padding: 1rem; border-bottom: var(--border-table);">
          <m-form-item mLabel="Source" *ngIf="rule.name | apply: fml.getSources as srcs">
            <span *ngIf="!srcs?.length">-</span>
            <div *ngFor="let src of srcs">{{src.object}}<b *ngIf="src.field">:{{src.field}}</b></div>
          </m-form-item>
          <m-form-item mLabel="Target" *ngIf="rule.name | apply: fml.getTargets as tgts">
            <span *ngIf="!tgts?.length">-</span>
            <div *ngFor="let tgt of tgts">{{tgt.object}}<b *ngIf="tgt.field">:{{tgt.field}}</b></div>
          </m-form-item>
        </div>


        <div class="form-view" style="padding: 1rem; border-bottom: var(--border-table);">
          <m-form-item mLabel="Position">
            x: {{rule.position?.x ?? '-'}}; y: {{rule.position?.y ?? '-'}}
          </m-form-item>
        </div>
      </div>
    </div>
  </div>
</div>


<m-modal #parameterModal (mClose)="editCancel(parameterModal)">
  <div *m-modal-header>
    Parameters
  </div>

  <div *m-modal-content>
    <ng-container *ngIf="_nodeSelected?.data?.rule as rule">
      <m-table mSize="small">
        <tr *ngFor="let param of rule.parameters; let first = first; let last = last">
          <td>
            <m-input *ngIf="param.type === 'const'" [(ngModel)]="param.value"></m-input>
            <kbd *ngIf="param.type === 'var'" class="description">{{param.value}}</kbd>
          </td>
          <td style="width: 0; padding: 0">
            <m-icon-button mIcon="up" [disabled]="first" (mClick)="moveParameter(rule.parameters, param, 'up')"/>
          </td>
          <td style="width: 0; padding: 0">
            <m-icon-button mIcon="down" [disabled]="last" (mClick)="moveParameter(rule.parameters, param, 'down')"/>
          </td>
          <td style="width: 0">
            <m-icon-button *ngIf="param.type === 'const'" mIcon="delete" (mClick)="removeParameter(rule.parameters, param)"/>
          </td>
        </tr>

        <tr>
          <td colspan="100%" style="padding: 0">
            <m-button style="width: 100%" mDisplay="text" mSize="small" (mClick)="addParameter(rule.parameters)">Add parameter</m-button>
          </td>
        </tr>
      </m-table>
    </ng-container>
  </div>

  <div *m-modal-footer class="m-justify-right">
    <m-button mDisplay="text" (mClick)="editCancel(parameterModal)">Cancel</m-button>
    <m-button mDisplay="primary" (mClick)="editApply(parameterModal)">Apply</m-button>
  </div>
</m-modal>

<m-modal #conditionModal (mClose)="editCancel(conditionModal)">
  <div *m-modal-header>
    Condition
  </div>

  <div *m-modal-content>
    <ng-container *ngIf="_nodeSelected?.data?.rule  as rule">
      <m-form-item mLabel="Expression">
        <m-input [(ngModel)]="rule.condition"></m-input>
      </m-form-item>

      <ng-container *ngIf="rule.name | apply: ctxVariables as ctxVars">
        <m-form-item mLabel="Context variables"
          *ngIf="ctxVars.length"
        >
          <div class="m-items-middle">
            <kbd *ngFor="let v of ctxVars | reverse" class="description">{{v}}</kbd>
          </div>
        </m-form-item>
      </ng-container>
    </ng-container>
  </div>

  <div *m-modal-footer class="m-justify-right">
    <m-button mDisplay="text" (mClick)="editCancel(conditionModal)">Cancel</m-button>
    <m-button mDisplay="primary" (mClick)="editApply(conditionModal)">Apply</m-button>
  </div>
</m-modal>
