<div style="height: 2.5rem; display: flex; align-items: center; background: linear-gradient(45deg, var(--color-primary-1), var(--color-background-component)); border-bottom: 1px solid var(--color-primary-2)">
  <div style="width: 100%; padding-inline: 1rem; white-space: nowrap;" class="m-justify-between">
    <div class="m-items-middle menu">
      <m-button mDisplay="text" (mClick)="wizard.open()" mSize="small">New</m-button>
      <m-button mDisplay="text" (mClick)="importer.open()" mSize="small">Import</m-button>
      <m-button mDisplay="text" (mClick)="exportStructureMap()" mSize="small">Export</m-button>
      <m-button mDisplay="text" *ngIf="isDev" (mClick)="viewAsFML(fmlPreview)" mSize="small">FML</m-button>

      <m-divider mVertical/>
      <m-button mDisplay="primary" (mClick)="save()" mSize="small">Save</m-button>
      <m-dropdown [mHideIfEmpty]="false">
        <div *m-dropdown-container>{{localstorage.getItem(SELECTED_STRUCTURE_MAPS_KEY)}}.json
          <m-icon *ngIf="localMaps[localstorage.getItem(SELECTED_STRUCTURE_MAPS_KEY)]" mCode="hdd"/>
        </div>
        <ng-container *ngFor="let m of structureMaps">
          <a *m-dropdown-item (mClick)="localstorage.setItem(SELECTED_STRUCTURE_MAPS_KEY, m); init()">{{m}}
            <m-icon *ngIf="localMaps[m]" mCode="hdd"/>
          </a>
        </ng-container>
      </m-dropdown>

      <ng-container *ngIf="resourceLoader">
        <m-divider mVertical/>
        <progress [value]="resourceLoader.current / resourceLoader.total * 100" max="100"></progress>
      </ng-container>
    </div>

    <div style="justify-self: end" class="m-items-middle">
      Animation
      <nz-switch [(ngModel)]="isAnimated" nzSize="small"></nz-switch>

      <m-divider mVertical/>
      <m-button (mClick)="autoLayout()" mSize="small">Auto-layout</m-button>
      <m-button (mClick)="topology()" mSize="small">Topology</m-button>
    </div>
  </div>
</div>

<div style="height: calc(100dvh - 2.5rem); display: grid; grid-template-columns: auto 1fr">
  <!-- LEFT PANEL -->
  <m-collapse-panel
    mKey="fml-left-panel"
    mResizable
    [mResizableMaxWidth]="400"
    style="height: calc(100vh - 2.5rem); background: var(--color-background-component); border-right: var(--border-table); z-index: 10"
  >
    <app-fml-view [fml]="fml"/>
  </m-collapse-panel>


  <!-- MAIN PANEL -->
  <div style="display: flex; flex-direction: column; max-height: calc(100dvh - 2.5rem)">
    <div class="editor-tabbar">
      <div *ngIf="!fmls[FML_MAIN]" class="editor-tab m-items-middle">
        <m-icon mCode="loading"/>
        <span>loading...</span>
      </div>

      <ng-container *ngIf="fmls[FML_MAIN]">
        <div
          *ngFor="let key of fmls | keys"
          class="editor-tab m-justify-between"
          [class.editor-tab--selected]="key === fmlSelected"
          (click)="selectGroup(key)"
        >
          <div class="m-items-middle">
            <m-icon mCode="file"/>
            <span>{{key}}</span>
          </div>
          <m-icon *ngIf="key !== FML_MAIN" class="m-clickable" mCode="close" (click)="deleteGroup(key)"/>
        </div>

        <div class="editor-tab" style="min-width: 2.5rem" (click)="fmlSetup.open()">
          <m-icon mCode="file-add"/>
          <app-structure-map-setup #fmlSetup [bundle]="resourceBundle" (created)="createGroup($event.name, $event.fml)"/>
        </div>
      </ng-container>

    </div>

    <div style="flex: auto; display: grid; grid-template-columns: 8fr 2fr; max-height: calc(100% - 32px - 1px)">
      <div id="drawflow-parent" [class.drawflow--animated]="isAnimated" (dragover)="onDragOver($event)" (drop)="onDrop($event)"></div>
      <!-- RIGHT PANEL -->
      <div style="border-left: var(--border-table);  height: 100%; overflow: auto; background: var(--color-background-component)">
        <ng-container *ngIf="!nodeSelected">
          <div style="padding: 1rem; border-bottom: var(--border-table);" *ngIf="ruleGroups.length">
            <h5>Groups</h5>

            <m-list mSeparated>
              <m-list-item *ngFor="let rg of ruleGroups" class="m-clickable" draggable="true" (dragstart)="onGroupDragStart($event, rg)">
                <div class="m-items-middle">
                  <m-icon mCode="folder"/>
                  <m-divider mVertical></m-divider>
                  {{rg.groupName}}
                </div>
              </m-list-item>
            </m-list>
          </div>

          <div style="padding: 1rem; border-bottom: var(--border-table);">
            <h5>Transformers</h5>
            <m-list mSeparated>
              <m-list-item *ngFor="let rd of ruleDescriptions" class="m-clickable" draggable="true" (dragstart)="onRuleDragStart($event, rd)">
                <div class="m-items-middle">
                  <m-icon mCode="experiment"/>
                  <m-divider mVertical></m-divider>
                  <div>
                    <div>{{rd.name}}</div>
                    <div class="description">{{rd.description}}</div>
                  </div>
                </div>
              </m-list-item>
            </m-list>
          </div>
        </ng-container>


        <ng-container *ngIf="nodeSelected as node">
          <!-- Resource -->
          <div *ngIf="node.data.obj as obj">
            <app-object-view [object]="obj" [fml]="fml" (fieldSelect)="onStructureItemSelect($event.object, $event.field, $event.type)"/>
          </div>

          <!-- Rule -->
          <div *ngIf="node.data.rule as rule">
            <app-rule-view [rule]="rule" [fml]="fml" (ruleChange)="applyRule($event)"/>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>


<!-- FML preview modal -->
<m-modal #fmlPreview mPlacement="top" mStyle="width:100%; max-width: 90rem" (mClose)="fmlResult = undefined">
  <div *m-modal-content>
    <ng-container *ngIf="{t: 'fml'} as d">
      <m-radio-group [(ngModel)]="d.t" style="margin-bottom: 1rem; display: inline-block">
        <label m-radio mValue="fml">FML</label>
        <label m-radio mValue="json">JSON</label>
      </m-radio-group>

      <ng-container [ngSwitch]="d.t">
        <pre *ngSwitchCase="'fml'" style="font-size: 13px; line-height: 1.25;">{{fmlResult.text}}</pre>
        <pre *ngSwitchCase="'json'" style="font-size: 13px; line-height: 1.25;">{{fmlResult.json | json}}</pre>
      </ng-container>
    </ng-container>
  </div>
</m-modal>


<!-- FML preview modal -->
<m-modal #importer mPlacement="top" (mClose)="importer.close()">
  <div *m-modal-header>
    Import StructureMap
  </div>
  <div *m-modal-content>
    <m-textarea [autosize]="{minRows: 10}" placeholder="JSON file content" (mChange)="importStructureMap(importer, $event)"></m-textarea>
  </div>
</m-modal>

<!-- Setup wizard -->
<app-structure-map-setup #wizard [bundle]="resourceBundle" (created)="initFromWizard($event.name, $event.fml)"/>


<app-update-version/>
