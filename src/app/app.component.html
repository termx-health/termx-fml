<div style="height: 2.5rem; display: flex; align-items: center; background: linear-gradient(45deg, var(--color-primary-1), var(--color-background-component)); border-bottom: 1px solid var(--color-primary-2)">
  <div style="width: 100%; padding-inline: 1rem; white-space: nowrap;" class="m-justify-between">
    <div class="m-items-middle menu">
      <m-dropdown>
        <m-button *m-dropdown-container mDisplay="text" mSize="small">File</m-button>
        <a *m-dropdown-item (mClick)="wizard.open()">New</a>
        <a *m-dropdown-item (mClick)="importer.open()">Import</a>
        <a *m-dropdown-item (mClick)="exportStructureMap()">Export</a>
      </m-dropdown>

      <m-dropdown>
        <m-button *m-dropdown-container mDisplay="text" mSize="small">Edit</m-button>
        <a *m-dropdown-item
          class="m-items-middle"
          (mClick)="configureActiveGroup()"
        >
          <m-icon mCode="setting"/>
          Configure group
        </a>
      </m-dropdown>

      <m-dropdown>
        <m-button *m-dropdown-container mDisplay="text" mSize="small">View</m-button>
        <a *m-dropdown-item (mClick)="autoLayout()">Auto-layout</a>
        <a *m-dropdown-item (mClick)="topology()">Topology</a>
        <a *m-dropdown-item (mClick)="collapseAll()">Collapse elements</a>
        <a *m-dropdown-item (mClick)="expandAll()">Expand elements</a>
      </m-dropdown>

      <m-button mDisplay="text" *ngIf="isIframe || isDev" (mClick)="viewAsFML(fmlPreview)" mSize="small" [mLoading]="loader.state['render-fml']">
        Preview
      </m-button>

      <m-button mDisplay="primary" (mClick)="save()" mSize="small">
        Save
      </m-button>

      <span *ngIf="isIframe" class="m-primary-color">{{ctx.selectedMapName}}</span>
      <m-dropdown *ngIf="!isIframe" [mHideIfEmpty]="false">
        <div *m-dropdown-container>{{ctx.selectedMapName ?? 'xxx'}}.json
          <m-icon *ngIf="ctx.isSaved(ctx.selectedMapName)" mCode="hdd"/>
        </div>
        <ng-container *ngFor="let m of ctx.maps$ | async">
          <a *m-dropdown-item (mClick)="ctx.selectMap(m)">{{m}}
            <m-icon *ngIf="ctx.isSaved(m)" mCode="hdd"/>
          </a>
        </ng-container>
      </m-dropdown>

      <ng-container *ngIf="isIframe">
        <m-divider mVertical/>
        <div class="description">Embedded</div>
      </ng-container>
      <ng-container *ngIf="isDev">
        <m-divider mVertical/>
        <div class="description">Dev</div>
      </ng-container>
    </div>

    <div class="m-items-middle">
      <m-icon-button mIcon="zoom-out" m-tooltip mTitle="Zoom Out" (mClick)="zoomOut()"/>
      <m-icon-button mIcon="zoom-in" m-tooltip mTitle="Zoom In" (mClick)="zoomIn()"/>

      <m-divider mVertical/>
      Animation
      <nz-switch [(ngModel)]="isAnimated" (ngModelChange)="setAnimation($event)" nzSize="small"></nz-switch>

      <ng-container *ngIf="isIframe">
        <m-divider mVertical/>
        <m-button (mClick)="exit()" mSize="small">Exit</m-button>
      </ng-container>
    </div>
  </div>
</div>

<app-editor
  *ngIf="ctx.structureMap$ | async as sm"
  style="height: calc(100dvh - 2.5rem)"
  [iframe]="isIframe"
  [bundle]="ctx.bundle$ | async"
  [structureMap]="sm"
  [externalMaps]="ctx.externalStructureMaps$ | async"
  [mapName]="sm.name"
></app-editor>


<!-- FML preview modal -->
<m-modal #fmlPreview mPlacement="top" mStyle="width:100%; max-width: 90rem" (mClose)="fml = undefined">
  <div *m-modal-content>
    <ng-container *ngIf="{t: 'fml'} as d">
      <m-radio-group [(ngModel)]="d.t" style="margin-bottom: 1rem; display: inline-block">
        <label m-radio mValue="fml">FML</label>
        <label m-radio mValue="json">JSON</label>
      </m-radio-group>

      <ng-container [ngSwitch]="d.t">
        <pre *ngSwitchCase="'fml'" style="font-size: 13px; line-height: 1.25;"><div [innerHTML]="fml.text | apply: formatFmlOutput: fml.json"></div></pre>
        <pre *ngSwitchCase="'json'" style="font-size: 13px; line-height: 1.25;">{{fml.json | json}}</pre>
      </ng-container>
    </ng-container>
  </div>
</m-modal>


<!-- FML import modal -->
<m-modal #importer mPlacement="top" (mClose)="importer.close()">
  <div *m-modal-header>
    Import StructureMap
  </div>
  <div *m-modal-content>
    <m-form-item mLabel="File">
      <input #i style="width: 100%" type="file" (change)="importStructureMap(importer, i.files[0])"/>
    </m-form-item>
    <m-form-item mLabel="JSON">
      <m-textarea [autosize]="{minRows: 10}" placeholder="Insert raw JSON here..." (mChange)="importStructureMap(importer, $event)"/>
    </m-form-item>
  </div>
</m-modal>

<!-- Changes modal-->
<m-modal #changeModal mPlacement="top" (mClose)="changeModal.close()">
  <div *m-modal-header>
    Changes
  </div>
  <div *m-modal-content>
    <ul>
      <li *ngFor="let change of changes" [innerHTML]="change.text"></li>
    </ul>
  </div>

  <div *m-modal-footer class="m-justify-between">
    <m-button mDisplay="text" (mClick)="changeModal.close(); save(true)">Save without changes</m-button>
    <div class="m-items-middle">
      <m-button mDisplay="text" (mClick)="cancelChanges()">Cancel</m-button>
      <m-button mDisplay="primary" (mClick)="applyChanges()">Apply</m-button>
    </div>
  </div>
</m-modal>

<!-- Setup wizard -->
<app-structure-map-setup #wizard [bundle]="ctx.bundle$ | async" (created)="initFromGroup($event.fmlGroup)"/>


<app-update-version/>
