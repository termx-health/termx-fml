<div style="height: 2.5rem; display: flex; align-items: center; padding-inline: 1rem; border-bottom: 1px solid var(--color-borders);">
  <div style="width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr" class="m-justify-between">
    <div class="m-items-middle">
      <m-button (mClick)="_setupWizard = true" mSize="small">New</m-button>

      <m-button (mClick)="importer.open()" mSize="small">Import</m-button>
      <m-button (mClick)="export()" mSize="small">Export</m-button>
      <m-button *ngIf="_dev" (mClick)="exportAsFML(fmlPreview)" mSize="small">FML</m-button>

      <m-divider mVertical/>
      <m-button mDisplay="primary" (mClick)="save()" mSize="small">Save</m-button>
      <m-dropdown [mHideIfEmpty]="false">
        <div *m-dropdown-container>{{localstorage.getItem('selected_structure_map')}}.json
          <m-icon *ngIf="localMaps[localstorage.getItem('selected_structure_map')]" mCode="database"/>
        </div>
        <ng-container *ngFor="let m of maps">
          <a *m-dropdown-item (mClick)="localstorage.setItem('selected_structure_map', m); init()">{{m}}
            <m-icon *ngIf="localMaps[m]" mCode="database"/>
          </a>
        </ng-container>
      </m-dropdown>

      <m-divider mVertical/>
      <m-button (mClick)="topology()" mSize="small">Topology</m-button>
    </div>

    <div class="m-items-middle" style="justify-self: center">
      <ng-container *ngIf="resourceLoader">
        <progress [value]="resourceLoader.current / resourceLoader.total * 100" max="100"></progress>
      </ng-container>
    </div>

    <div style="justify-self: end">
      Animation
      <nz-switch [(ngModel)]="isAnimated" nzSize="small"></nz-switch>
    </div>
  </div>
</div>

<div style="height: calc(100dvh - 2.5rem); display: grid; grid-template-columns: 2fr 8fr 2fr">
  <!-- LEFT PANEL -->
  <div style="border-right: var(--border-table); height: 100%; overflow: auto; background: var(--color-background-component);">
    <app-fml-view [fml]="fml"/>
  </div>


  <!-- MAIN PANEL -->
  <div id="drawflow-parent" [class.drawflow--animated]="isAnimated" (dragover)="onDragOver($event)" (drop)="onDrop($event)">
    <!--<div id="drawflow" style="height: 100%; width: 100%; outline: none"></div>-->
  </div>


  <!-- RIGHT PANEL -->
  <div style="border-left: var(--border-table);  height: 100%; overflow: auto; background: var(--color-background-component)">
    <div *ngIf="!nodeSelected" style="padding: 1rem; border-bottom: var(--border-table);">
      <h5>Transformers</h5>
      <m-list mSeparated>
        <m-list-item
          *ngFor="let rd of ruleDescriptions"
          class="m-clickable"
          draggable="true"
          (dragstart)="onDragStart($event, rd)"
        >
          <div>{{rd.name}}</div>
          <div class="description">{{rd.description}}</div>
        </m-list-item>
      </m-list>
    </div>


    <div *ngIf="nodeSelected as node">
      <!-- Resource -->
      <div *ngIf="node.data.obj as obj">
        <app-object-view [object]="obj" [fml]="fml" (fieldSelect)="onStructureItemSelect($event.object, $event.field, $event.type)"/>
      </div>

      <!-- Rule -->
      <div *ngIf="node.data.rule as rule">
        <app-rule-view [rule]="rule" [fml]="fml" (ruleChange)="applyRule($event)"/>
      </div>
    </div>
  </div>
</div>


<!-- FML preview modal -->
<m-modal #fmlPreview mPlacement="top" mStyle="width:100%; max-width: 90rem" (mClose)="_fmlResult = undefined">
  <div *m-modal-content>
    <pre>{{_fmlResult}}</pre>
  </div>
</m-modal>


<!-- FML preview modal -->
<m-modal #importer mPlacement="top" (mClose)="importer.close()">
  <div *m-modal-header>
    Import FHIR StructureMap
  </div>
  <div *m-modal-content>
    <m-textarea [autosize]="{minRows: 10}" (mChange)="importStructureMap(importer, $event)"></m-textarea>
  </div>
</m-modal>

<!-- Setup wizard -->
<m-modal #wizard [mVisible]="_setupWizard" mPlacement="top" (mClose)="_setupWizard = false">
  <ng-container *ngIf="_setupWizard">
    <form #f="ngForm" *ngIf="{name: '', sources: [], targets:[]} as data">
      <div *m-modal-header>
        StructureMap setup
      </div>

      <div *m-modal-content>
        <m-form-item mName="name" mLabel="Name" required>
          <m-input name="name" [(ngModel)]="data.name" required/>
        </m-form-item>

        <m-form-row>
          <m-form-item *m-form-col mName="sources" mLabel="Sources" required>
            <app-structure-definition-select name="sources" [(ngModel)]="data.sources" [bundle]="fml.bundle" multiple required/>
          </m-form-item>

          <m-form-item *m-form-col mName="targets" mLabel="Target" required>
            <app-structure-definition-select name="targets" [(ngModel)]="data.targets" [bundle]="fml.bundle" multiple required/>
          </m-form-item>
        </m-form-row>
      </div>

      <div *m-modal-footer>
        <m-button mDisplay="primary" style="width: 100%" (mClick)="initFromWizard(data)" [disabled]="f.invalid">
          Let's Go
        </m-button>
      </div>
    </form>
  </ng-container>
</m-modal>

